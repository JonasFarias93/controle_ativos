{% extends "base.html" %}

{% block content %}
    <style>
        .table-container { 
            border: 1px solid #ccc; 
            overflow-x: auto; 
            max-height: 500px; 
            margin-top: 15px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; white-space: nowrap; }
        th { background-color: #f2f2f2; position: sticky; top: 0; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Estilos do Modal que você já usa */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 900px; }
        .section-title { border-bottom: 2px solid #5cb85c; padding-bottom: 5px; color: #5cb85c; font-size: 16px; }
    </style>

    <div class="header-actions mt-4">
        <h1>{{ titulo_pagina }}</h1>
        <button id="openModalBtn" class="btn btn-success">Adicionar Novo Ativo</button>
    </div>

    <div class="table-container shadow-sm bg-white">
        <table class="table">
            <thead>
                <tr>
                    <th>JAVA</th>
                    <th>C. EQUIPAMENTO</th>
                    <th>EQUIPAMENTO</th>
                    <th>CATEGORIA</th>
                    <th>ATIVO ID</th>
                    <th>Nº DE SÉRIE</th>
                    <th>DATA SEPARAÇÃO</th>
                    <th>CHAMADO / Nº</th>
                    <th>DATA SAÍDA</th>
                    <th>SMARTX</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                {% for ativo in ativos %}
                <tr>
                    <td>---</td> 
                    <td>{{ ativo.codigo_equipamento }}</td>
                    <td>{{ ativo.tipo.nome }}</td>
                    <td>{{ ativo.chamado.categoria.nome }}</td> 
                    <td>{{ ativo.ativo_id|default:"N/A" }}</td>
                    <td>{{ ativo.nr_serie }}</td>
                    <td>{{ ativo.chamado.data_separacao|date:"d/m/Y" }}</td>
                    <td>{{ ativo.chamado.numero_chamado }}</td>
                    <td>{{ ativo.chamado.data_saida|date:"d/m/Y" }}</td>
                    <td>{{ ativo.chamado.get_smartx_display }}</td>
                    <td>{{ ativo.get_status_display }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center">Nenhum ativo encontrado no inventário.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="adicionarAtivoModal" class="modal">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h2 class="h4">Novo Ativo e Chamado</h2>
                <span class="close" id="closeModalBtn" style="cursor:pointer; font-size: 2rem;">&times;</span>
            </div>
            
            <form method="post" action="{% url 'controle_ativos:adicionar_ativo_chamado' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="section-title text-success fw-bold">Dados do Chamado</p>
                            <div class="mb-3">
                                {{ form_novo_ativo.categoria.label_tag }}
                                {{ form_novo_ativo.categoria }}
                            </div>
                            <div class="mb-3">
                                {{ form_novo_ativo.numero_chamado.label_tag }}
                                {{ form_novo_ativo.numero_chamado }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <p class="section-title text-success fw-bold">Dados do Ativo</p>
                            {% for field in form_novo_ativo %}
                                {% if field.name not in "categoria,numero_chamado,data_separacao" %}
                                    <div class="mb-2">
                                        {{ field.label_tag }}
                                        {{ field }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer mt-3">
                    <button type="button" class="btn btn-secondary" id="fecharModalBtn">Fechar</button>
                    <button type="submit" class="btn btn-primary">Salvar Ativo</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById("adicionarAtivoModal");
        const btn = document.getElementById("openModalBtn");
        const span = document.getElementById("closeModalBtn");
        const btnFechar = document.getElementById("fecharModalBtn");

        btn.onclick = () => modal.style.display = "block";
        span.onclick = () => modal.style.display = "none";
        btnFechar.onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }
    </script>
{% endblock %}